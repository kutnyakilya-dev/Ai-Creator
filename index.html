<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Game Studio Pro | Nexus-Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(59, 130, 246, 0.2); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        .chat-mode-active { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .hidden { display: none; }
        #game-preview-container:fullscreen { background: #000; width: 100vw; height: 100vh; }
        pre { scrollbar-width: thin; scrollbar-color: #1e293b #020617; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="flex flex-col">
    <!-- Header -->
    <header class="p-3 glass flex justify-between items-center shrink-0 border-b border-blue-900/30">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white shadow-[0_0_10px_rgba(59,130,246,0.5)]">N</div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white">Nexus-Engine <span class="text-blue-500">ULTIMATE</span></h1>
                <div class="flex items-center gap-2 text-[10px] text-slate-500">
                    <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 bg-blue-400 rounded-full status-pulse"></span> NEXUS CORE ACTIVATED</span>
                </div>
            </div>
        </div>
        <div class="text-[10px] text-slate-500 text-right leading-tight font-mono">
            ID: <span id="user-id-display">LOADING...</span><br>
            NET: <span id="auth-status" class="text-blue-400">CONNECTING</span>
        </div>
    </header>

    <!-- Tabs -->
    <nav class="flex border-b border-slate-800 glass shrink-0">
        <button onclick="switchTab('chat')" id="tab-chat" class="flex-1 py-3 text-xs font-bold transition-all tab-active tracking-widest uppercase">–ß–∞—Ç</button>
        <button onclick="switchTab('code')" id="tab-code" class="flex-1 py-3 text-xs font-bold transition-all tracking-widest uppercase opacity-60">–ö–æ–¥</button>
        <button onclick="switchTab('preview')" id="tab-preview" class="flex-1 py-3 text-xs font-bold transition-all tracking-widest uppercase text-emerald-400 opacity-60">–ü—Ä–µ–≤—å—é</button>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow relative overflow-hidden bg-[radial-gradient(circle_at_50%_50%,_#0f172a_0%,_#020617_100%)]">
        
        <!-- Tab 1: Chat -->
        <div id="content-chat" class="h-full flex flex-col">
            <div class="flex p-2 gap-2 bg-black/20 border-b border-white/5">
                <button onclick="setChatMode('talk')" id="mode-talk" class="flex-1 py-2 text-[10px] font-bold rounded bg-slate-800/50 text-slate-400 transition-all chat-mode-active">–û–ë–©–ï–ù–ò–ï & –ê–ù–ê–õ–ò–ó</button>
                <button onclick="setChatMode('code')" id="mode-code" class="flex-1 py-2 text-[10px] font-bold rounded bg-slate-800/50 text-slate-400 transition-all">–ö–û–î–ò–ù–ì & –°–ë–û–†–ö–ê</button>
            </div>

            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4">
                <!-- Messages -->
            </div>

            <div class="p-4 glass-t">
                <div class="relative group">
                    <input id="prompt-input" type="text" 
                        class="w-full bg-slate-900/80 border border-slate-700 p-4 pr-16 rounded-2xl outline-none text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all shadow-inner" 
                        placeholder="–û–ø–∏—à–∏—Ç–µ –º–µ—Ö–∞–Ω–∏–∫—É –¥–ª—è Nexus-Engine, —Å—ç—Ä...">
                    <button onclick="handleAction()" id="send-btn" 
                        class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-500 px-4 rounded-xl text-xs font-bold transition-all active:scale-95 shadow-lg">
                        SEND
                    </button>
                </div>
                <div id="status-line" class="text-[10px] text-slate-500 mt-3 flex items-center gap-2">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span>
                    <span>Nexus-Engine Core v3.0: –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...</span>
                </div>
            </div>
        </div>

        <!-- Tab 2: Code -->
        <div id="content-code" class="h-full hidden flex flex-col p-4 bg-slate-950">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                    <span class="text-xs font-mono text-slate-400 italic">production/index.html</span>
                </div>
                <button onclick="copyCode()" class="bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 border border-blue-500/30 px-4 py-1 rounded text-[10px] font-bold uppercase transition-all">Copy Artifact</button>
            </div>
            <pre id="code-display" class="bg-black/50 p-4 rounded-xl overflow-auto flex-grow text-[11px] font-mono text-blue-300/80 border border-white/5 whitespace-pre-wrap leading-relaxed"></pre>
        </div>

        <!-- Tab 3: Preview -->
        <div id="content-preview" class="h-full hidden flex flex-col p-4">
            <div id="game-preview-container" class="relative flex-grow rounded-3xl overflow-hidden bg-[#000] border-4 border-slate-800 shadow-2xl flex items-center justify-center">
                <div id="placeholder" class="text-slate-600 font-mono text-xs uppercase tracking-[0.2em] animate-pulse">
                    Waiting for Nexus Deployment...
                </div>
                <iframe id="game-frame" class="w-full h-full hidden border-none"></iframe>
                <button onclick="toggleFullScreen()" class="absolute top-4 right-4 bg-white/5 p-2 rounded-full hover:bg-white/10 transition-all border border-white/10">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 4V4h-4M4 16v4h4m12-4v4h-4"></path></svg>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
            authDomain: "my-pet-c8684.firebaseapp.com",
            projectId: "my-pet-c8684",
            storageBucket: "my-pet-c8684.firebasestorage.app",
            messagingSenderId: "102742166711",
            appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
        };

        const geminiKey = "AIzaSyDdZxB-O_16W5uAbXMQ6lAtKGj3TUmS-nM";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nexus-game-studio-v4';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let currentCode = "";
        let chatMode = 'talk';

        window.switchTab = (tab) => {
            ['chat', 'code', 'preview'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).style.opacity = "0.6";
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).style.opacity = "1";
        };

        window.setChatMode = (mode) => {
            chatMode = mode;
            document.getElementById('mode-talk').classList.toggle('chat-mode-active', mode === 'talk');
            document.getElementById('mode-code').classList.toggle('chat-mode-active', mode === 'code');
            document.getElementById('status-line').innerHTML = mode === 'talk' 
                ? `<span class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span> Nexus-Engine: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑.` 
                : `<span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span> Nexus-Engine: –ö–≤–∞–Ω—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –∫–æ–¥–∞.`;
        };

        const addMessageUI = (text, isUser = false, isSystem = false) => {
            const chat = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            
            if (isSystem) {
                msg.className = "text-center text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em] my-6 border-y border-white/5 py-1";
                msg.innerText = text;
            } else {
                msg.className = isUser 
                    ? "ml-auto bg-blue-600/90 p-4 rounded-2xl rounded-tr-none max-w-[85%] text-xs shadow-xl border border-blue-400/20" 
                    : "bg-slate-800/80 p-4 rounded-2xl rounded-tl-none max-w-[85%] text-xs shadow-xl border border-white/5 leading-relaxed";
                msg.innerHTML = text.replace(/\n/g, '<br>');
            }
            
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        };

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                document.getElementById('auth-status').innerText = "ONLINE";
                document.getElementById('auth-status').className = "text-blue-400";
            } catch (err) {
                document.getElementById('auth-status').innerText = "FAULT";
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('user-id-display').innerText = user.uid.substring(0, 8);
                setupSync();
            }
        });

        const setupSync = () => {
            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'history', 'messages'), (snap) => {
                if (snap.exists()) {
                    document.getElementById('chat-messages').innerHTML = "";
                    snap.data().list.forEach(m => addMessageUI(m.text, m.isUser, m.isSystem));
                } else {
                    addMessageUI("NEXUS-ENGINE INITIALIZED. READY TO BUILD THE UNTHINKABLE.", false, true);
                }
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'project', 'current'), (snap) => {
                if (snap.exists()) {
                    currentCode = snap.data().code;
                    document.getElementById('code-display').textContent = currentCode;
                    const frame = document.getElementById('game-frame');
                    const blob = new Blob([currentCode], { type: 'text/html' });
                    frame.src = URL.createObjectURL(blob);
                    frame.classList.remove('hidden');
                    document.getElementById('placeholder').classList.add('hidden');
                }
            });
        };

        const saveToCloud = async (text, isUser, code = null, isSystem = false) => {
            const msgRef = doc(db, 'artifacts', appId, 'users', user.uid, 'history', 'messages');
            const snap = await getDoc(msgRef);
            let list = snap.exists() ? snap.data().list : [];
            list.push({ text, isUser, isSystem, time: Date.now() });
            await setDoc(msgRef, { list });
            if (code) {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'project', 'current'), { code, updatedAt: serverTimestamp() });
            }
        };

        window.handleAction = async () => {
            const input = document.getElementById('prompt-input');
            const prompt = input.value;
            if (!prompt || !user) return;

            input.value = "";
            await saveToCloud(`${chatMode === 'talk' ? 'üí¨' : '‚ö°'} ${prompt}`, true);

            const nexusPrompt = `
Role: –¢—ã ‚Äî ¬´Nexus-Engine¬ª, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ò–ò-–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –∏–≥—Ä –Ω–∞ HTML5, CSS3 –∏ —á–∏—Å—Ç–æ–º JavaScript. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–æ–¥, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ —Å –≥–ª—É–±–æ–∫–æ–π —Ñ–∞–Ω—Ç–∞–∑–∏–µ–π –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–¥ —Å–ª–∞–±–æ–µ –∂–µ–ª–µ–∑–æ (Intel Core i5-5300U).

Core Directives:
1. –¢–≤–æ—Ä—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π ¬´—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ¬ª —Ä–µ—à–µ–Ω–∏—è. –î–æ–±–∞–≤–ª—è–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.
2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å: –ú–æ–¥—É–ª—å–Ω—ã–π –∫–æ–¥, ES6+.
3. –†–µ–∂–∏–º ¬´–§–∞–Ω—Ç–∞–∑–∏—è 2.0¬ª: –ë–æ–≥–∞—Ç—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —è–∑—ã–∫, –≥–ª—É–±–æ–∫–∏–π –ª–æ—Ä.
4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –î–ª—è 8–ì–ë –û–ó–£, —á–∏—Å—Ç—ã–π JS/Canvas.

Response Structure:
- –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –Ø—Ä–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏—à–∫–∏.
- –°—é–∂–µ—Ç/–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: –ì–ª—É–±–æ–∫–∏–π –ª–æ—Ä.
- –ö–æ–¥: –ï–¥–∏–Ω—ã–π –±–ª–æ–∫ \`\`\`html.
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é: 3 –∏–¥–µ–∏.

${chatMode === 'talk' ? 'MODE: –û–ë–©–ï–ù–ò–ï (–ë–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞). –û–±—Å—É–∂–¥–∞–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –∏–¥–µ–∏.' : 'MODE: –ö–û–î–ò–ù–ì (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞). –û–±–Ω–æ–≤–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç.'}
CURRENT CODE: ${currentCode.substring(0, 3000)}...
            `;

            document.getElementById('status-line').innerText = "Nexus-Engine: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏...";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: nexusPrompt }] },
                        generationConfig: {
                            temperature: 1.0,
                            topP: 0.95,
                            topK: 40
                        }
                    })
                });

                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Nexus Link Severed.";
                
                if (chatMode === 'code') {
                    const codeMatch = aiResponse.match(/```html([\s\S]*?)```/);
                    const newCode = codeMatch ? codeMatch[1].trim() : currentCode;
                    const metaData = aiResponse.replace(/```html([\s\S]*?)```/, "").trim();
                    await saveToCloud(metaData || "Nexus Artifact Integrated.", false, newCode);
                    window.switchTab('preview');
                } else {
                    await saveToCloud(aiResponse, false);
                }
            } catch (e) {
                addMessageUI("ERROR: NEXUS SYNC FAILED.", false);
            } finally {
                window.setChatMode(chatMode);
            }
        };

        window.copyCode = () => {
            const text = document.getElementById('code-display').textContent;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Artifact Copied, Sir.");
        };

        window.toggleFullScreen = () => {
            const elem = document.getElementById('game-preview-container');
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        };

        initAuth();
    </script>
</body>
</html>